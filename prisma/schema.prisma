generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String        @id @default(cuid())
  name           String
  email          String        @unique
  phoneNumber    String        @unique
  password       String
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  Vehicle        Vehicle[]
  ServiceBooking Appointment[]

  CustomerNotification CustomerNotification[]
}

enum Role {
  ADMIN
  CUSTOMER
  SERVICE_CENTER
}

model ServiceCenter {
  id             String        @id @default(cuid())
  name           String
  email          String        @unique
  password       String
  phoneNumber    String        @unique
  city           String
  latitude       Float?
  longitude      Float?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  ServiceBooking Appointment[]
  Inventory      Inventory[]

  ServiceCenterNotification ServiceCenterNotification[]

  Mechanic Mechanic[]
}

enum Vtype {
  CAR
  TRUCK
  BIKE
}

model Vehicle {
  id           String        @id @default(cuid())
  vehicleName  String
  vehicleMake  String
  vehicleModel Int
  vehicleType  Vtype
  numberPlate  String        @unique
  userId       String
  owner        User          @relation(fields: [userId], references: [id])
  service      Appointment[]
  createdAt    DateTime      @default(now())
}

enum bookingStatus {
  APPROVED
  REJECTED
  PENDING
  InService
  COMPLETED
}

enum AppointmentPriority {
  LOW
  MEDIUM
  HIGH
}

model Appointment {
  id                        String                      @id @default(cuid())
  vehicleId                 String
  userId                    String
  serviceType               String
  requestedDate             DateTime                    @default(now())
  slaDeadline               DateTime?
  actualCompletionDate      DateTime?
  slaBreached               Boolean                     @default(false)
  priority                  AppointmentPriority?
  status                    bookingStatus
  isAccidental              Boolean                     @default(false)
  photos                    String[]
  serviceCenterId           String
  owner                     User                        @relation(fields: [userId], references: [id])
  Vehicle                   Vehicle                     @relation(fields: [vehicleId], references: [id])
  serviceCenter             ServiceCenter               @relation(fields: [serviceCenterId], references: [id])
  JobCards                  JobCards[]
  Invoice                   Invoice?
  CustomerNotification      CustomerNotification[]
  ServiceCenterNotification ServiceCenterNotification[]
  Triage                    Triage[]
  Payment                   Payment?
  Mechanic                  Mechanic[]

  @@index([vehicleId])
  @@index([serviceCenterId])
  @@index([userId])
}

enum TriageSource {
  AUTO
  MANUAL
}

enum TriageReason {
  INITIAL
  ESCALATION
  REOPEN
  MANUAL_OVERRIDE
}

model Triage {
  id              String              @id @default(cuid())
  appointmentId   String              @unique
  appointment     Appointment         @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  decidedPriority AppointmentPriority // final decision
  source          TriageSource
  reason          TriageReason
  createdAt       DateTime            @default(now())

  @@index([appointmentId])
}

model JobCards {
  id             String         @id @default(cuid())
  appointmentId  String
  appointment    Appointment    @relation(fields: [appointmentId], references: [id])
  jobName        String
  jobDescription String
  price          Int
  JobCardParts   JobCardParts[]

  @@index([appointmentId])
}

model JobCardParts {
  id        String    @id @default(uuid())
  jobCardId String
  jobCard   JobCards  @relation(fields: [jobCardId], references: [id], onDelete: Cascade)
  partId    String
  partUsed  Inventory @relation(fields: [partId], references: [id], onDelete: Cascade)
  quantity  Int
}

enum Category {
  ENGINE_PARTS
  ELECTRICAL
  BRAKE_SYSTEM
  SUSPENSION
  FLUIDS
  TOOLS
  BODY_PARTS
  ACCESSORIES
  MISC
}

enum MechanicStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
}

enum MechanicSpeciality {
  ENGINE
  BRAKES
  ELECTRICAL
  SUSPENSION
  TRANSMISSION
  BODYWORK
  GENERAL_SERVICE
}

model Mechanic {
  id                  String             @id @default(cuid())
  name                String
  phoneNumber         String             @unique
  email               String?            @unique
  experienceYears     Int
  status              MechanicStatus     @default(ACTIVE)
  speciality          MechanicSpeciality
  appointmentId       String?
  appointmentAssigned Appointment?       @relation(fields: [appointmentId], references: [id])

  serviceCenterId String
  serviceCenter   ServiceCenter @relation(fields: [serviceCenterId], references: [id])

  assignedAt   DateTime?
  unassignedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serviceCenterId, status])
  @@index([appointmentId])
}

model Inventory {
  id        String    @id @default(uuid())
  name      String
  sku       String    @unique
  brand     String?
  category  Category? // e.g., Engine Parts, Consumables, Electrical
  unitPrice Int
  quantity  Int       @default(0)

  createdAt       DateTime       @default(now())
  JobCardParts    JobCardParts[]
  serviceCenterId String
  serviceCenter   ServiceCenter  @relation(fields: [serviceCenterId], references: [id])

  @@index([serviceCenterId])
}

enum InvoiceStatus {
  SENT
  PAID
  OVERDUE
}

model Invoice {
  id            String        @id @default(cuid())
  invoiceCount  BigInt        @default(autoincrement())
  invoiceNumber String        @unique
  totalAmount   Int
  billingDate   DateTime      @default(now())
  dueDate       DateTime      @default(dbgenerated("now() + interval '7 days'"))
  status        InvoiceStatus @default(SENT)

  appointmentId String      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  Payment       Payment?
}

enum NotificationTargetType {
  CUSTOMER
  SERVICE_CENTER
}

enum NotificationType {
  APPOINTMENT_APPROVED
  APPOINTMENT_REJECTED
  APPOINTMENT_IN_SERVICE
  APPOINTMENT_COMPLETED
  INVOICE_GENERATED
  PAYMENT_PENDING
  PAYMENT_OVERDUE
}

model CustomerNotification {
  id            String           @id @default(cuid())
  customerId    String
  customer      User             @relation(fields: [customerId], references: [id], onDelete: Cascade)
  type          NotificationType
  message       String
  appointmentId String?
  appointment   Appointment?     @relation(fields: [appointmentId], references: [id])
  isRead        Boolean          @default(false)
  createdAt     DateTime         @default(now())

  @@index([customerId])
  @@index([appointmentId])
}

enum SCNotificationType {
  APPOINTMENT_CREATED
  PAYMENT_COMPLETED
  LOW_STOCK
  STOCK_EXHAUSTED
  APPOINTMENT_APPROVAL_SLA_BREACHED
}

model ServiceCenterNotification {
  id              String             @id @default(cuid())
  serviceCenterId String
  serviceCenter   ServiceCenter      @relation(fields: [serviceCenterId], references: [id], onDelete: Cascade)
  type            SCNotificationType
  message         String
  appointmentId   String?
  appointment     Appointment?       @relation(fields: [appointmentId], references: [id])

  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([serviceCenterId])
  @@index([appointmentId])
}

// Payment and Forgot Password For Customer;
enum PaymentStatus {
  INITIATED
  SUCCESS
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CASH
  UPI
  CARD
  NET_BANKING
}

model Payment {
  id String @id @default(cuid())

  invoiceId String  @unique
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  appointmentId String      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  amount Int // store in smallest unit (paise)
  method PaymentMethod
  status PaymentStatus @default(INITIATED)

  transactionId String?   @unique // gateway txn id
  paidAt        DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@index([appointmentId])
}
